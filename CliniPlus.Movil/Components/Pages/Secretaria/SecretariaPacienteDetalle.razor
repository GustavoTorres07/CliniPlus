@page "/secretaria/pacientes/{Id:int}"
@layout CliniPlus.Movil.Components.Layout.EmptyLayout

@using CliniPlus.Shared.DTOs
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Forms

@inject CliniPlus.Movil.Services.Contrato.IAuthService Auth
@inject CliniPlus.Movil.Services.Contrato.IPacienteService PacienteService
@inject CliniPlus.Movil.Services.Contrato.ITurnoService TurnoService
@inject NavigationManager Nav

@if (_cargando)
{
    <div class="home-loading d-flex flex-column align-items-center justify-content-center" style="height:70vh;">
        <div class="spinner-border text-primary mb-2"></div>
        <p class="text-muted small mb-0">Cargando datos del paciente...</p>
    </div>
}
else if (_usuario is null || _usuario.Rol != "Secretaria")
{
    <RedirectToLogin />
}
else if (_paciente is null)
{
    <div class="home-page">
        <div class="home-header mb-4">
            <div class="d-flex align-items-center gap-3">
                <button class="btn-back" @onclick="VolverListado">
                    <i class="bi bi-chevron-left"></i>
                </button>
                <div class="home-greeting">
                    <p class="home-hello">Secretaría</p>
                    <h4 class="home-name">Paciente no encontrado</h4>
                </div>
            </div>
        </div>

        <div class="home-card p-5 text-center">
            <i class="bi bi-emoji-frown text-muted fs-1 mb-3"></i>
            <p class="text-muted small mb-0">No se encontro informacion para este paciente.</p>
        </div>
    </div>
}
else
{
    <div class="home-page">

        <div class="home-header mb-4">
            <div class="d-flex align-items-center gap-3">
                <button class="btn-back" @onclick="VolverListado">
                    <i class="bi bi-chevron-left"></i>
                </button>
                <div class="home-greeting">
                    <p class="home-hello">Secretaria</p>
                    <h4 class="home-name text-truncate" style="max-width: 200px;">
                        @_paciente.NombreCompleto
                    </h4>
                    <span class="badge badge-secretaria mt-1">Paciente</span>
                </div>
            </div>

            <div class="home-avatar">
                <span>@GetInicial(_usuario.NombreCompleto)</span>
            </div>
        </div>

        <div class="home-card p-4 mb-3">
            <div class="d-flex align-items-center mb-3">
                <div class="patient-avatar-large me-3">
                    @GetInicial(_paciente.NombreCompleto)
                </div>
                <div class="flex-grow-1">
                    <div class="fw-bold text-dark fs-5">@_paciente.NombreCompleto</div>

                    @if (!string.IsNullOrWhiteSpace(_paciente.DNI))
                    {
                        <div class="small text-muted d-flex align-items-center mt-1">
                            <i class="bi bi-credit-card-2-front me-2 text-primary"></i>
                            DNI: @_paciente.DNI
                        </div>
                    }

                    @if (!string.IsNullOrWhiteSpace(_paciente.Email))
                    {
                        <div class="small text-muted d-flex align-items-center mt-1">
                            <i class="bi bi-envelope me-2 text-primary"></i>
                            @_paciente.Email
                        </div>
                    }

                    @if (!string.IsNullOrWhiteSpace(_paciente.Telefono))
                    {
                        <div class="small text-muted d-flex align-items-center mt-1">
                            <i class="bi bi-telephone me-2 text-success"></i>
                            @_paciente.Telefono
                        </div>
                    }
                </div>

                <div class="d-flex flex-column align-items-end gap-1">
                    <span class="badge-status @(_paciente.IsActive ? "bg-success-subtle text-success" : "bg-secondary-subtle text-muted")">
                        @(_paciente.IsActive ? "Activo" : "Inactivo")
                    </span>
                    @if (_paciente.IsProvisional)
                    {
                        <span class="badge bg-warning-subtle text-warning small mt-1">
                            Provisional
                        </span>
                    }
                </div>
            </div>

            @if (!string.IsNullOrWhiteSpace(_paciente.ObraSocialNombre))
            {
                <div class="small text-muted mt-2 pt-2 border-top border-light d-flex align-items-center">
                    <i class="bi bi-hospital me-2 text-info"></i>
                    <span>
                        Obra social: <strong>@_paciente.ObraSocialNombre</strong>
                        @if (!string.IsNullOrWhiteSpace(_paciente.NumeroAfiliado))
                        {
                            <span class="ms-1">– N° @_paciente.NumeroAfiliado</span>
                        }
                    </span>
                </div>
            }
        </div>

        <div class="home-card p-3 mb-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="section-title mb-0">
                    Historia clínica
                </h6>
            </div>

            <div class="row g-2 align-items-end">
                <div class="col-6">
                    <label class="label-mini">Desde</label>
                    <InputDate @bind-Value="_filtroDesde"
                               class="form-control input-modern" />
                </div>
                <div class="col-6">
                    <label class="label-mini">Hasta</label>
                    <InputDate @bind-Value="_filtroHasta"
                               class="form-control input-modern" />
                </div>
            </div>

            <button class="btn btn-outline-primary w-100 mt-3"
                    @onclick="AplicarFiltros"
                    disabled="_cargandoHistoria">
                @if (_cargandoHistoria)
                {
                    <span class="spinner-border spinner-border-sm me-2"></span>
                }
                <i class="bi bi-filter-circle me-1"></i>
                Aplicar filtros
            </button>

            <p class="text-muted small mt-2 mb-0">
                Consultas encontradas: <strong>@_historia.Count</strong>
            </p>
        </div>

        <div class="home-card p-3 mb-3">
            @if (_cargandoHistoria)
            {
                <div class="text-center py-4">
                    <div class="spinner-border spinner-border-sm text-primary mb-2"></div>
                    <p class="small text-muted mb-0">Cargando historia clínica...</p>
                </div>
            }
            else if (_historia is null || _historia.Count == 0)
            {
                <div class="text-center py-4 border-dashed">
                    <i class="bi bi-file-earmark-medical text-muted fs-2 mb-2"></i>
                    <p class="small text-muted mb-0">
                        No hay consultas registradas para este paciente en el rango seleccionado.
                    </p>
                </div>
            }
            else
            {
                <div class="d-flex flex-column gap-2">
                    @foreach (var item in _historia)
                    {
                        <button class="home-card p-2 text-start fade-in"
                                style="border-radius:14px;"
                                @onclick="@(() => VerDetalle(item.IdEntrada))">

                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <div class="fw-bold small text-dark">
                                    @item.Fecha.ToString("dd/MM/yyyy HH:mm")
                                </div>
                                <i class="bi bi-chevron-right text-primary"></i>
                            </div>

                            @if (!string.IsNullOrWhiteSpace(item.CIE10Codigo) ||
                                 !string.IsNullOrWhiteSpace(item.CIE10Descripcion))
                            {
                                <div class="small text-muted">
                                    <i class="bi bi-clipboard2-pulse me-1 text-danger"></i>
                                    @item.CIE10Codigo
                                    @if (!string.IsNullOrWhiteSpace(item.CIE10Descripcion))
                                    {
                                        <span> - @item.CIE10Descripcion</span>
                                    }
                                </div>
                            }

                            @if (!string.IsNullOrWhiteSpace(item.NotasResumen))
                            {
                                <div class="small text-muted mt-1 text-truncate">
                                    <i class="bi bi-chat-left-text me-1 text-secondary"></i>
                                    @item.NotasResumen
                                </div>
                            }
                        </button>
                    }
                </div>
            }
        </div>

        <div class="home-card p-3 mb-5 consulta-detalle-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="section-title mb-0">
                    Detalle de consulta
                </h6>

                @if (_detalleSeleccionado is not null)
                {
                    <span class="consulta-fecha-pill">
                        <i class="bi bi-calendar2-week me-1"></i>
                        @_detalleSeleccionado.Fecha.ToString("dd/MM/yyyy HH:mm")
                    </span>
                }
            </div>

            @if (_cargandoDetalle)
            {
                <div class="text-center py-3">
                    <div class="spinner-border spinner-border-sm text-primary mb-2"></div>
                    <p class="small text-muted mb-0">Cargando detalle...</p>
                </div>
            }
            else if (_detalleSeleccionado is null)
            {
                <div class="consulta-empty text-center py-3">
                    <i class="bi bi-journal-medical text-muted fs-3 mb-2 d-block"></i>
                    <p class="small text-muted mb-0">
                        Seleccioná una consulta de la lista para ver el detalle.
                    </p>
                </div>
            }
            else
            {
                <div class="consulta-section mb-2">
                    <div class="consulta-label">
                        <i class="bi bi-person-heart me-2 text-primary"></i>
                        <span>Médico</span>
                    </div>
                    <div class="consulta-value">
                        @_detalleSeleccionado.MedicoNombre
                    </div>
                </div>

                <div class="consulta-divider"></div>

                <div class="consulta-section mb-2">
                    <div class="consulta-label">
                        <i class="bi bi-clipboard2-pulse me-2 text-danger"></i>
                        <span>Diagnóstico (CIE-10)</span>
                    </div>
                    <div class="consulta-value">
                        @_detalleSeleccionado.CIE10Codigo
                        @if (!string.IsNullOrWhiteSpace(_detalleSeleccionado.CIE10Descripcion))
                        {
                            <span> - @_detalleSeleccionado.CIE10Descripcion</span>
                        }
                    </div>
                </div>

                @if (!string.IsNullOrWhiteSpace(_detalleSeleccionado.Notas))
                {
                    <div class="consulta-divider"></div>

                    <div class="consulta-section mb-2">
                        <div class="consulta-label">
                            <i class="bi bi-chat-left-text me-2 text-secondary"></i>
                            <span>Notas / Observaciones</span>
                        </div>
                        <p class="consulta-notas mb-0">
                            @_detalleSeleccionado.Notas
                        </p>
                    </div>
                }

                @if (_detalleSeleccionado.TurnoId.HasValue || _detalleSeleccionado.ConsultaId.HasValue)
                {
                    <div class="consulta-divider mt-2 mb-2"></div>
                    <div class="consulta-badges d-flex flex-wrap gap-2">
                        @if (_detalleSeleccionado.TurnoId.HasValue)
                        {
                            <span class="consulta-pill turno-pill">
                                <i class="bi bi-calendar-check me-1"></i>
                                Turno #@_detalleSeleccionado.TurnoId
                                @if (_detalleSeleccionado.TurnoFechaHora.HasValue)
                                {
                                    <span class="ms-1">
                                        · @_detalleSeleccionado.TurnoFechaHora.Value.ToString("dd/MM/yyyy HH:mm")
                                    </span>
                                }
                            </span>
                        }
                        @if (_detalleSeleccionado.ConsultaId.HasValue)
                        {
                            <span class="consulta-pill consulta-pill-secondary">
                                <i class="bi bi-file-earmark-medical me-1"></i>
                                Consulta #@_detalleSeleccionado.ConsultaId
                                @if (_detalleSeleccionado.ConsultaFechaHora.HasValue)
                                {
                                    <span class="ms-1">
                                        · @_detalleSeleccionado.ConsultaFechaHora.Value.ToString("dd/MM/yyyy HH:mm")
                                    </span>
                                }
                            </span>
                        }
                    </div>

                    @if (!string.IsNullOrWhiteSpace(_detalleSeleccionado.TipoTurnoNombre) ||
                            !string.IsNullOrWhiteSpace(_detalleSeleccionado.EstadoTurno))
                    {
                        <div class="small text-muted mt-2">
                            @if (!string.IsNullOrWhiteSpace(_detalleSeleccionado.TipoTurnoNombre))
                            {
                                <span class="me-2">
                                    <i class="bi bi-tags me-1"></i>
                                    @_detalleSeleccionado.TipoTurnoNombre
                                </span>
                            }
                            @if (!string.IsNullOrWhiteSpace(_detalleSeleccionado.EstadoTurno))
                            {
                                <span>
                                    <i class="bi bi-circle-half me-1"></i>
                                    @_detalleSeleccionado.EstadoTurno
                                </span>
                            }
                        </div>
                    }
                }
            }
        </div>

        <div class="spacer-bottom-large" style="height:80px;"></div>
    </div>
}

<div class="bottom-nav shadow-soft">
    <button class="bottom-nav-item" @onclick="IrHome">
        <i class="bi bi-house-door-fill"></i>
        <span>Inicio</span>
    </button>
    <button class="bottom-nav-item" @onclick="IrTurnosHoy">
        <i class="bi bi-calendar-check"></i>
        <span>Turnos</span>
    </button>
    <button class="bottom-nav-item active" @onclick="IrPacientes">
        <i class="bi bi-people"></i>
        <span>Pacientes</span>
    </button>
</div>

@code {
    [Parameter] public int Id { get; set; } 

    private AuthMeResponse? _usuario;
    private bool _cargando = true;

    private bool _cargandoHistoria = false;
    private bool _cargandoDetalle = false;

    private PacienteDetalleDTO? _paciente;
    private List<HistoriaClinicaListadoDTO> _historia = new();
    private HistoriaClinicaDetalleDTO? _detalleSeleccionado;

    private DateTime? _filtroDesde;
    private DateTime? _filtroHasta;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _usuario = await Auth.MeAsync();

            if (_usuario is null || _usuario.Rol != "Secretaria")
            {
                Nav.NavigateTo("/", true);
                return;
            }

            if (Id <= 0)
            {
                Nav.NavigateTo("/secretaria/pacientes", true);
                return;
            }

            _paciente = await PacienteService.ObtenerAsync(Id);

            if (_paciente is null)
            {
                Nav.NavigateTo("/secretaria/pacientes", true);
                return;
            }

            _filtroHasta = DateTime.Today;
            _filtroDesde = DateTime.Today.AddMonths(-6);

            await CargarHistoria();
        }
        catch
        {
            Nav.NavigateTo("/", true);
        }
        finally
        {
            _cargando = false;
        }
    }

    private async Task CargarHistoria()
    {
        _cargandoHistoria = true;
        _detalleSeleccionado = null;

        try
        {
            var lista = await TurnoService.ObtenerHistoriaSecretariaAsync(
                Id,
                _filtroDesde,
                _filtroHasta
            );

            _historia = lista ?? new List<HistoriaClinicaListadoDTO>();
        }
        finally
        {
            _cargandoHistoria = false;
            StateHasChanged();
        }
    }

    private Task AplicarFiltros() => CargarHistoria();

    private async Task VerDetalle(int entradaId)
    {
        _cargandoDetalle = true;

        try
        {
            _detalleSeleccionado = await TurnoService.ObtenerHistoriaSecretariaDetalleAsync(Id, entradaId);
        }
        finally
        {
            _cargandoDetalle = false;
            StateHasChanged();
        }
    }


    private string GetInicial(string? nombre) =>
        string.IsNullOrWhiteSpace(nombre) ? "?" : nombre[0].ToString().ToUpper();

    private void VolverListado() => Nav.NavigateTo("/secretaria/pacientes", true);
    private void IrHome() => Nav.NavigateTo("/secretaria/home", true);
    private void IrTurnosHoy() => Nav.NavigateTo("/secretaria/turnos/hoy", true);
    private void IrPacientes() => Nav.NavigateTo("/secretaria/pacientes", true);
}
