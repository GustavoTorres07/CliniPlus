@page "/secretaria/home"
@layout CliniPlus.Movil.Components.Layout.EmptyLayout

@using CliniPlus.Shared
@using CliniPlus.Shared.DTOs
@inject CliniPlus.Movil.Services.Contrato.IAuthService Auth
@inject NavigationManager Nav

@if (_cargando)
{
    <div class="home-loading d-flex flex-column align-items-center justify-content-center" style="height: 60vh;">
        <div class="spinner-border text-primary me-2"></div>
        <p class="mt-2 text-muted small">Cargando panel de secretaría...</p>
    </div>
}
else if (_usuario is null)
{
    <RedirectToLogin />
}
else
{
    <div class="home-page">
        <div class="home-header mb-4">
            <div class="home-greeting">
                <p class="home-hello">Hola,</p>
                <h4 class="home-name">@_usuario.NombreCompleto</h4>
                <span class="badge badge-secretaria mt-1">
                    Secretaría
                </span>
            </div>

            <div class="d-flex align-items-center gap-2">
                <button class="btn-logout" @onclick="CerrarSesion" title="Cerrar sesión">
                    <i class="bi bi-box-arrow-right"></i>
                </button>
                <div class="home-avatar">
                    <span>@GetInicial(_usuario.NombreCompleto)</span>
                </div>
            </div>
        </div>

        <h6 class="section-title">Turnos</h6>
        <div class="home-quick-actions mb-4">
            <button class="quick-card" @onclick="IrTurnosHoy">
                <div class="icon-box bg-blue-light">
                    <i class="bi bi-calendar-day text-primary"></i>
                </div>
                <span>Turnos de hoy</span>
            </button>
            <button class="quick-card" @onclick="IrTurnosPorMedico">
                <div class="icon-box bg-purple-light">
                    <i class="bi bi-calendar-week text-purple"></i>
                </div>
                <span>Por médico</span>
            </button>
        </div>

        <h6 class="section-title">Pacientes</h6>
        <div class="home-quick-actions mb-4">
            <button class="quick-card" @onclick="IrPacientes">
                <div class="icon-box bg-green-light">
                    <i class="bi bi-person-lines-fill text-green"></i>
                </div>
                <span>Listado</span>
            </button>
            <button class="quick-card" @onclick="IrNuevoPaciente">
                <div class="icon-box bg-orange-light">
                    <i class="bi bi-person-plus text-orange"></i>
                </div>
                <span>Alta Paciente</span>
            </button>
        </div>

        <h6 class="section-title">Médicos</h6>
        <div class="home-quick-actions mb-4">
            <button class="quick-card" @onclick="IrMedicos">
                <div class="icon-box bg-blue-light">
                    <i class="bi bi-person-badge text-primary"></i>
                </div>
                <span>Listado Médicos</span>
            </button>
            <button class="quick-card" @onclick="IrHorariosMedicos">
                <div class="icon-box bg-purple-light">
                    <i class="bi bi-clock-history text-purple"></i>
                </div>
                <span>Horarios</span>
            </button>
            <button class="quick-card" @onclick="IrEspecialidades">
                <div class="icon-box bg-teal-light">
                    <i class="bi bi-journal-medical text-info"></i>
                </div>
                <span>Especialidades</span>
            </button>
        </div>

        <h6 class="section-title">Obras sociales</h6>
        <div class="home-quick-actions mb-4">
            <button class="quick-card" @onclick="IrObrasSociales">
                <div class="icon-box bg-teal-light">
                    <i class="bi bi-hospital text-info"></i>
                </div>
                <span>Gestionar obras sociales</span>
            </button>
        </div>

        <div class="home-card mb-2">
            <div class="home-card-header">
                <span class="home-card-title">Resumen del día</span>
                <i class="bi bi-graph-up text-muted"></i>
            </div>
            <div class="admin-metrics">
                <div class="metric-row">
                    <span class="metric-label">
                        <i class="bi bi-calendar-check me-2 text-primary"></i>
                        Turnos totales
                    </span>
                    <span class="metric-value">0</span>
                </div>
                <div class="metric-divider"></div>
                <div class="metric-row">
                    <span class="metric-label">
                        <i class="bi bi-check2-circle me-2 text-success"></i>
                        Confirmados / Atendidos
                    </span>
                    <span class="metric-value">0</span>
                </div>
                <div class="metric-divider"></div>
                <div class="metric-row">
                    <span class="metric-label">
                        <i class="bi bi-x-circle me-2 text-danger"></i>
                        Cancelados
                    </span>
                    <span class="metric-value">0</span>
                </div>
            </div>
        </div>

        <div class="spacer-bottom"></div>
    </div>
}

<div class="bottom-nav shadow-soft">
    <button class="bottom-nav-item active" @onclick="IrInicio">
        <i class="bi bi-house-door-fill"></i>
        <span>Inicio</span>
    </button>
    <button class="bottom-nav-item" @onclick="IrTurnosHoy">
        <i class="bi bi-calendar-event"></i>
        <span>Turnos</span>
    </button>
    <button class="bottom-nav-item" @onclick="IrPacientes">
        <i class="bi bi-people"></i>
        <span>Pacientes</span>
    </button>
    <button class="bottom-nav-item" @onclick="CerrarSesion">
        <i class="bi bi-box-arrow-right"></i>
        <span>Salir</span>
    </button>
</div>

@code {
    private AuthMeResponse? _usuario;
    private bool _cargando = true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _cargando = true;
            _usuario = await Auth.MeAsync();

            if (_usuario is null || _usuario.Rol != "Secretaria")
            {
                Nav.NavigateTo("/", true);
                return;
            }
        }
        catch
        {
            Nav.NavigateTo("/", true);
        }
        finally
        {
            _cargando = false;
        }
    }

    private async Task CerrarSesion()
    {
        await Auth.LogoutAsync();
        Nav.NavigateTo("/", true);
    }

    private string GetInicial(string? nombre) =>
        string.IsNullOrWhiteSpace(nombre) ? "?" : nombre[0].ToString().ToUpper();

    private void IrInicio() => Nav.NavigateTo("/secretaria/home", true);

    private void IrTurnosHoy() => Nav.NavigateTo("/secretaria/turnos/hoy");
    private void IrTurnosPorMedico() => Nav.NavigateTo("/secretaria/turnos/agenda");

    private void IrPacientes() => Nav.NavigateTo("/secretaria/pacientes", true);
    private void IrNuevoPaciente() => Nav.NavigateTo("/secretaria/pacientes/alta", true);

    private void IrMedicos() => Nav.NavigateTo("/secretaria/medicos");
    private void IrHorariosMedicos() => Nav.NavigateTo("/secretaria/medicos", true);

    private void IrObrasSociales() => Nav.NavigateTo("/secretaria/obras-sociales", true);

    private void IrEspecialidades() => Nav.NavigateTo("/secretaria/especialidades", true);
}
