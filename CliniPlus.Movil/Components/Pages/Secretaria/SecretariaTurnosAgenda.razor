@page "/secretaria/turnos/agenda"
@layout CliniPlus.Movil.Components.Layout.EmptyLayout

@using CliniPlus.Shared.DTOs
@inject CliniPlus.Movil.Services.Contrato.IAuthService Auth
@inject CliniPlus.Movil.Services.Contrato.ITurnoService TurnoService
@inject CliniPlus.Movil.Services.Contrato.IMedicoService MedicoService
@inject NavigationManager Nav

@if (_cargando)
{
    <div class="home-loading d-flex flex-column align-items-center justify-content-center" style="height:60vh;">
        <div class="spinner-border text-primary mb-3"></div>
        <span>Cargando agenda...</span>
    </div>
}
else if (_usuario is null)
{
    <RedirectToLogin />
}
else
{
    <div class="home-page">

        <div class="home-header mb-4">
            <div class="home-greeting">
                <p class="home-hello">Agenda por medico</p>
                <h4 class="home-name">@_usuario.NombreCompleto</h4>
                <span class="badge badge-secretaria mt-1">
                    <i class="bi bi-shield-check"></i>
                    Secretaría
                </span>
            </div>

            <div class="d-flex align-items-center gap-2">
                <button class="btn-logout" @onclick="CerrarSesion" title="Cerrar sesión">
                    <i class="bi bi-box-arrow-right"></i>
                </button>
                <div class="home-avatar">
                    <span>@GetInicial(_usuario.NombreCompleto)</span>
                </div>
            </div>
        </div>

        <div class="home-card p-4 mb-3">
            <h6 class="section-title mb-3">Filtrar Busqueda</h6>

            <div class="mb-3">
                <label class="label-mini">Medico</label>
                <select class="form-select input-modern"
                        @bind="_medicoSeleccionadoId">
                    <option value="0">Seleccionar medico...</option>
                    @foreach (var m in _medicos)
                    {
                        <option value="@m.IdMedico">@m.NombreCompleto (@m.Especialidad)</option>
                    }
                </select>
            </div>

            <div class="date-filters">
                <div class="date-input-group">
                    <label class="label-mini">Desde</label>
                    <InputDate @bind-Value="_desde"
                               class="form-control input-modern p-2 text-center" />
                </div>
                <div class="date-input-group">
                    <label class="label-mini">Hasta</label>
                    <InputDate @bind-Value="_hasta"
                               class="form-control input-modern p-2 text-center" />
                </div>
                <button class="search-button"
                        @onclick="BuscarTurnos"
                        title="Buscar">
                    <i class="bi bi-search"></i>
                </button>
            </div>
        </div>

        <div class="d-flex flex-column gap-3 mb-5">
            @if (_cargandoLista)
            {
                <div class="empty-state">
                    <div class="spinner-border text-primary spinner-sm"></div>
                    <p class="empty-text">Cargando turnos...</p>
                </div>
            }
            else if (_turnos is null || _turnos.Count == 0)
            {
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="bi bi-calendar-x"></i>
                    </div>
                    <p class="empty-text">No se encontraron turnos para el filtro seleccionado.</p>
                </div>
            }
            else
            {
                @foreach (var t in _turnos)
                {
                    <div class="turn-item fade-in estado-@t.Estado.ToLower().Replace(" ", "-")">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <div class="turn-time">
                                    @t.ScheduledAtUtc.ToString("HH:mm")
                                    <small>hs</small>
                                </div>
                                <div class="turn-date">
                                    @t.ScheduledAtUtc.ToString("HH:mm")
                                </div>
                            </div>
                            <span class="@GetBadgeClass(t.Estado)">
                                @t.Estado
                            </span>
                        </div>

                        <div class="small text-muted mb-1 d-flex align-items-center gap-2">
                            <i class="bi bi-person-badge text-primary"></i>
                            <span class="text-truncate">
                                <strong>Paciente:</strong> @(!string.IsNullOrWhiteSpace(t.PacienteNombre) ? t.PacienteNombre : "Sin asignar")
                            </span>
                        </div>

                        <div class="small text-muted d-flex align-items-center gap-2">
                            <i class="bi bi-person-vcard text-success"></i>
                            <span class="text-truncate">
                                <strong>Medico:</strong> @t.MedicoNombre
                            </span>
                        </div>

                        @if (!string.IsNullOrWhiteSpace(t.PacienteDni))
                        {
                            <div class="info-detail">
                                <i class="bi bi-credit-card-2-front"></i>
                                <span>DNI: @t.PacienteDni</span>
                            </div>
                        }

                        @if (!string.IsNullOrWhiteSpace(t.TipoTurnoNombre))
                        {
                            <div class="info-detail">
                                <i class="bi bi-tag-fill"></i>
                                <span>@t.TipoTurnoNombre</span>
                            </div>
                        }

                        @if (t.Estado == "Reservado")
                        {
                            <div class="mt-3 d-flex justify-content-end">
                                <button class="btn btn-sm btn-outline-danger"
                                        @onclick="() => CancelarTurno(t)">
                                    <i class="bi bi-x-circle me-1"></i> Cancelar
                                </button>
                            </div>
                        }
                    </div>
                }
            }
        </div>

        <div class="spacer-bottom-large"></div>
    </div>
}

<div class="bottom-nav shadow-soft">
    <button class="bottom-nav-item" @onclick="IrInicio">
        <i class="bi bi-house-door-fill"></i>
        <span>Inicio</span>
    </button>
    <button class="bottom-nav-item active">
        <i class="bi bi-calendar-week-fill"></i>
        <span>Agenda</span>
    </button>
    <button class="bottom-nav-item" @onclick="IrPacientes">
        <i class="bi bi-people-fill"></i>
        <span>Pacientes</span>
    </button>
</div>

@code {
    private AuthMeResponse? _usuario;
    private bool _cargando = true;
    private bool _cargandoLista = false;

    private List<MedicoListadoDTO> _medicos = new();
    private int _medicoSeleccionadoId;

    private DateTime? _desde;
    private DateTime? _hasta;

    private List<TurnoListadoSecretariaDTO> _turnos = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _cargando = true;
            _usuario = await Auth.MeAsync();

            if (_usuario is null || _usuario.Rol != "Secretaria")
            {
                Nav.NavigateTo("/", true);
                return;
            }

            _desde = DateTime.Today;
            _hasta = DateTime.Today;

            await CargarMedicos();

            if (_medicos.Count > 0)
            {
                _medicoSeleccionadoId = _medicos.First().IdMedico;
                await BuscarTurnos();
            }
        }
        catch
        {
            Nav.NavigateTo("/", true);
        }
        finally
        {
            _cargando = false;
        }
    }

    private async Task CargarMedicos()
    {
        var lista = await MedicoService.ListarAsync(null) ?? new List<MedicoListadoDTO>();
        _medicos = lista
            .Where(m => m.IsActive)
            .OrderBy(m => m.NombreCompleto)
            .ToList();
    }

    private async Task BuscarTurnos()
    {
        if (_medicoSeleccionadoId <= 0)
        {
            _turnos = new List<TurnoListadoSecretariaDTO>();
            return;
        }

        _cargandoLista = true;
        try
        {
            _turnos = await TurnoService.ListarAgendaSecretariaAsync(
                            _medicoSeleccionadoId,
                            _desde,
                            _hasta
                        ) ?? new List<TurnoListadoSecretariaDTO>();
        }
        finally
        {
            _cargandoLista = false;
            StateHasChanged();
        }
    }

    private async Task CancelarTurno(TurnoListadoSecretariaDTO turno)
    {
        if (turno == null)
            return;

        if (!string.Equals(turno.Estado, "Reservado", StringComparison.OrdinalIgnoreCase))
            return;

        var ok = await TurnoService.CancelarTurnoSecretariaAsync(turno.IdTurno);

        if (ok)
        {
            turno.Estado = "Cancelado";
            StateHasChanged();
        }
    }

    private string GetBadgeClass(string estado)
    {
        return estado switch
        {
            "Cancelado" => "badge-status bg-danger-subtle",
            "Reservado" => "badge-status bg-primary-subtle",
            "Atendido" => "badge-status bg-success-subtle",
            "No Asistio" => "badge-status bg-warning-subtle",
            _ => "badge-status bg-secondary-subtle"
        };
    }

    private async Task CerrarSesion()
    {
        await Auth.LogoutAsync();
        Nav.NavigateTo("/", true);
    }

    private string GetInicial(string? nombre) =>
        string.IsNullOrWhiteSpace(nombre) ? "?" : nombre[0].ToString().ToUpper();

    private void IrInicio() => Nav.NavigateTo("/secretaria/home", true);
    private void IrPacientes() => Nav.NavigateTo("/admin/pacientes");
}