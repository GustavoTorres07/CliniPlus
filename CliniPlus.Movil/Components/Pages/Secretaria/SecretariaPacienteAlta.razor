@page "/secretaria/pacientes/alta"
@layout CliniPlus.Movil.Components.Layout.EmptyLayout

@using CliniPlus.Shared.DTOs
@inject CliniPlus.Movil.Services.Contrato.IAuthService Auth
@inject CliniPlus.Movil.Services.Contrato.IPacienteService PacienteService
@inject CliniPlus.Movil.Services.Contrato.IObraSocialService ObraSocialService
@inject NavigationManager Nav

@if (_cargando)
{
    <div class="home-loading d-flex flex-column align-items-center justify-content-center" style="height:60vh;">
        <div class="spinner-border text-primary mb-2"></div>
        <p class="text-muted small mb-0">Preparando alta de paciente...</p>
    </div>
}
else if (_usuario is null || _usuario.Rol != "Secretaria")
{
    <RedirectToLogin />
}
else
{
    <div class="home-page">

        <div class="home-header mb-4">
            <div class="d-flex align-items-center gap-3">
                <button class="btn-back" @onclick="VolverListado">
                    <i class="bi bi-chevron-left"></i>
                </button>
                <div class="home-greeting">
                    <p class="home-hello">Secretaría</p>
                    <h4 class="home-name">Alta de paciente</h4>
                    <span class="badge badge-secretaria mt-1">
                        Vincular usuario → paciente
                    </span>
                </div>
            </div>

            <div class="home-avatar">
                <span>@GetInicial(_usuario.NombreCompleto)</span>
            </div>
        </div>

        <EditForm Model="_model" OnValidSubmit="GuardarPaciente">
            <DataAnnotationsValidator />

            <div class="home-card p-4 mb-4 shadow-sm">
                <h6 class="section-title mb-3">Datos requeridos</h6>

                <div class="mb-4 bg-light p-3 rounded-3 border border-light">
                    <label class="label-mini text-primary">ID de Usuario (Existente)</label>
                    <InputNumber class="form-control input-modern text-center fw-bold fs-5"
                                 @bind-Value="_usuarioId"
                                 placeholder="0" />
                    <p class="small text-muted mt-2 mb-0" style="line-height: 1.3;">
                        <i class="bi bi-info-circle me-1"></i>
                        Ingresá el ID de un usuario registrado con rol <strong>Paciente</strong> que aún no tenga ficha.
                    </p>
                </div>

                <div class="mb-3">
                    <label class="label-mini">DNI</label>
                    <InputText class="form-control input-modern"
                               @bind-Value="_model.DNI"
                               placeholder="Ej: 40123456" />
                    <ValidationMessage For="@(() => _model.DNI)" class="text-danger small mt-1" />
                </div>

                <div class="mb-3">
                    <label class="label-mini">Teléfono</label>
                    <InputText class="form-control input-modern"
                               @bind-Value="_model.Telefono"
                               placeholder="Ej: 387-1234567" />
                     <ValidationMessage For="@(() => _model.Telefono)" class="text-danger small mt-1" />
                </div>

                <div class="mb-3">
                    <label class="label-mini">Obra social</label>
                    <InputSelect class="form-select input-modern"
                                 @bind-Value="_model.ObraSocialId">
                        <option value="">Sin obra social</option>
                        @foreach (var o in _obrasSociales)
                        {
                            <option value="@o.IdObraSocial">@o.Nombre</option>
                        }
                    </InputSelect>
                </div>

                <div class="mb-2">
                    <label class="label-mini">Número de afiliado</label>
                    <InputText class="form-control input-modern"
                               @bind-Value="_model.NumeroAfiliado"
                               placeholder="Opcional" />
                </div>
            </div>

            <div class="fixed-bottom-action p-3 bg-white shadow-lg border-top">
                @if (!string.IsNullOrWhiteSpace(_error))
                {
                    <div class="alert alert-danger py-2 px-3 small mb-3 d-flex align-items-center rounded-3 fade-in">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i> @_error
                    </div>
                }

                @if (!string.IsNullOrWhiteSpace(_ok))
                {
                    <div class="alert alert-success py-2 px-3 small mb-3 d-flex align-items-center rounded-3 fade-in">
                        <i class="bi bi-check-circle-fill me-2"></i> @_ok
                    </div>
                }

                <button type="submit"
                        class="btn btn-primary btn-pill w-100 py-3 shadow-soft fw-bold d-flex justify-content-center align-items-center gap-2"
                        disabled="@_guardando">
                    @if (_guardando)
                    {
                        <span class="spinner-border spinner-border-sm me-2"></span>
                        <span>Procesando...</span>
                    }
                    else
                    {
                        <i class="bi bi-person-plus-fill"></i>
                        <span>Crear Paciente</span>
                    }
                </button>
            </div>

        </EditForm>

        <div class="spacer-bottom-large"></div>
    </div>
}

<div class="bottom-nav shadow-soft">
    <button class="bottom-nav-item" @onclick="IrHome">
        <i class="bi bi-house-door-fill"></i>
        <span>Inicio</span>
    </button>
    <button class="bottom-nav-item" @onclick="IrTurnosHoy">
        <i class="bi bi-calendar-check"></i>
        <span>Turnos</span>
    </button>
    <button class="bottom-nav-item active" @onclick="VolverListado">
        <i class="bi bi-people-fill"></i>
        <span>Pacientes</span>
    </button>
</div>

@code {
    private AuthMeResponse? _usuario;
    private bool _cargando = true;
    private bool _guardando = false;

    private int? _usuarioId;
    private PacienteCrearDTO _model = new();
    private List<ObraSocialDTO> _obrasSociales = new();

    private string? _error;
    private string? _ok;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _usuario = await Auth.MeAsync();

            if (_usuario is null || _usuario.Rol != "Secretaria")
            {
                Nav.NavigateTo("/", true);
                return;
            }

            var lista = await ObraSocialService.ListarAsync();
            _obrasSociales = lista ?? new List<ObraSocialDTO>();
        }
        catch
        {
            Nav.NavigateTo("/", true);
        }
        finally
        {
            _cargando = false;
        }
    }

    private async Task GuardarPaciente()
    {
        _error = null;
        _ok = null;

        if (!_usuarioId.HasValue || _usuarioId.Value <= 0)
        {
            _error = "Debés ingresar un ID de usuario válido.";
            return;
        }

        _guardando = true;

        try
        {
            _model.UsuarioId = _usuarioId.Value;

            var creado = await PacienteService.CrearAsync(_model);

            if (creado is null)
            {
                _error = "No se pudo crear. Verificá que el usuario exista y no sea ya un paciente.";
            }
            else
            {
                _ok = "Paciente creado correctamente.";
                
                await Task.Delay(1500);
                Nav.NavigateTo($"/secretaria/pacientes/{creado.IdPaciente}", true);
            }
        }
        catch
        {
            _error = "Ocurrió un error al procesar la solicitud.";
        }
        finally
        {
            _guardando = false;
        }
    }

    private string GetInicial(string? nombre) => 
        string.IsNullOrWhiteSpace(nombre) ? "?" : nombre[0].ToString().ToUpper();

    private void VolverListado() => Nav.NavigateTo("/secretaria/pacientes", true);
    private void IrHome() => Nav.NavigateTo("/secretaria/home", true);
    private void IrTurnosHoy() => Nav.NavigateTo("/secretaria/turnos/hoy", true);
}