@page "/Administrador/pacientes/crear"
@layout CliniPlus.Movil.Components.Layout.EmptyLayout
@using CliniPlus.Shared.DTOs
@using CliniPlus.Movil.Services.Contrato
@using CliniPlus.Shared
@using Microsoft.AspNetCore.Components.Forms
@inject IAuthService Auth
@inject IPacienteService PacienteSrv
@inject IObraSocialService ObrasSrv
@inject NavigationManager Nav

@if (_cargando)
{
    <div class="home-loading d-flex flex-column align-items-center justify-content-center" style="height: 60vh;">
        <div class="spinner-border text-success mb-3"></div>
        <span>Cargando formulario...</span>
    </div>
}
else if (!_permitido)
{
    <RedirectToLogin />
}
else
{
    <div class="home-page">
        <div class="home-header mb-4">
            <div class="d-flex align-items-center gap-3">
                <BotonVolver />
                <div class="home-greeting">
                    <p class="home-hello">Gestión</p>
                    <h4 class="home-name mb-0">Nuevo Paciente</h4>
                </div>
            </div>
        </div>

        <div class="home-card p-4">
            <EditForm Model="_model" OnValidSubmit="GuardarAsync">
                <DataAnnotationsValidator />

                <div class="mb-3">
                    <label class="form-label small fw-bold text-muted">DNI *</label>
                    <div class="input-group input-elevated">
                        <span class="input-group-text bg-transparent border-0">
                            <i class="bi bi-credit-card-2-front"></i>
                        </span>
                        <InputText class="form-control border-0 bg-transparent" 
                                   placeholder="Ej. 12345678" 
                                   @bind-Value="_model.DNI" />
                    </div>
                    <ValidationMessage For="@(() => _model.DNI)" />
                </div>

                <div class="row g-3 mb-3">
                    <div class="col-6">
                        <label class="form-label small fw-bold text-muted">Teléfono</label>
                        <div class="input-group input-elevated">
                            <span class="input-group-text bg-transparent border-0 px-2">
                                <i class="bi bi-telephone"></i>
                            </span>
<InputText class="form-control border-0 bg-transparent px-1" 
           placeholder="123456" 
           @bind-Value="_model.Telefono" />
                        </div>
                    </div>
                    <div class="col-6">
                        <label class="form-label small fw-bold text-muted">Email</label>
                        <div class="input-group input-elevated">
                            <span class="input-group-text bg-transparent border-0 px-2">
                                <i class="bi bi-envelope"></i>
                            </span>
<InputText class="form-control border-0 bg-transparent px-1" 
           placeholder="correo@ejemplo.com" 
           @bind-Value="_model.Email" />
                        </div>
                    </div>
                </div>
                <ValidationMessage For="@(() => _model.Telefono)" />
                <ValidationMessage For="@(() => _model.Email)" />

                <div class="mb-3">
                    <label class="form-label small fw-bold text-muted">Obra Social</label>
                    <div class="input-group input-elevated">
                        <span class="input-group-text bg-transparent border-0">
                            <i class="bi bi-heart-pulse"></i>
                        </span>
                        <InputSelect class="form-select border-0 bg-transparent" @bind-Value="_model.ObraSocialId">
                            <option value="">Sin obra social (Particular)</option>
                            @foreach (var o in _obrasSociales)
                            {
                                <option value="@o.IdObraSocial">@o.Nombre</option>
                            }
                        </InputSelect>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="form-label small fw-bold text-muted">Número de afiliado</label>
                    <div class="input-group input-elevated">
                        <span class="input-group-text bg-transparent border-0">
                            <i class="bi bi-credit-card"></i>
                        </span>
<InputText class="form-control border-0 bg-transparent" 
           placeholder="Número de afiliado" 
           @bind-Value="_model.NumeroAfiliado" />
                    </div>
                </div>

                <hr class="my-3 opacity-25" />

                <div class="form-check form-switch mb-2">
                    <InputCheckbox class="form-check-input" id="chkProv" @bind-Value="_model.IsProvisional" />
                    <label class="form-check-label fw-bold small" for="chkProv">
                        Paciente provisional (sin cuenta App)
                    </label>
                </div>
                <p class="small text-muted mb-3 bg-light p-2 rounded border-start border-4 border-warning">
                    <i class="bi bi-info-circle me-1"></i> 
                    Permite reservar turnos sin usuario. Luego se puede vincular.
                </p>

                @if (!_model.IsProvisional)
                {
                    <div class="mb-4 fade-in">
                        <label class="form-label small fw-bold text-muted">Vincular Usuario ID (Opcional)</label>
                        <div class="input-group input-elevated">
                            <span class="input-group-text bg-transparent border-0">
                                <i class="bi bi-person-badge"></i>
                            </span>
                            <InputNumber class="form-control border-0 bg-transparent" 
                                         placeholder="Ej. 10" 
                                         @bind-Value="_model.UsuarioId" />
                        </div>
                    </div>
                }

                <div class="d-flex gap-2">
                    <button type="button" 
                            class="btn btn-outline-secondary btn-pill flex-fill" 
                            @onclick="VolverLista" 
                            disabled="@_guardando">
                        Cancelar
                    </button>
                    
                    <button type="submit" 
                            class="btn btn-primary btn-pill flex-fill shadow-sm" 
                            disabled="@_guardando">
                        @if (_guardando)
                        {
                            <span><span class="spinner-border spinner-border-sm me-1"></span> Guardando...</span>
                        }
                        else
                        {
                            <span>Guardar</span>
                        }
                    </button>
                </div>

                @if (!string.IsNullOrWhiteSpace(_error))
                {
                    <div class="alert alert-danger mt-3 small text-center border-0 bg-danger-subtle text-danger">
                        <i class="bi bi-exclamation-triangle me-1"></i> @_error
                    </div>
                }
            </EditForm>
        </div>

        <div class="spacer-bottom"></div>
    </div>
}

<div class="bottom-nav shadow-soft">
    <button class="bottom-nav-item" @onclick="IrInicio">
        <i class="bi bi-house-door"></i>
        <span>Inicio</span>
    </button>
    
    <button class="bottom-nav-item active">
        <i class="bi bi-person-lines-fill"></i>
        <span>Pacientes</span>
    </button>

    <button class="bottom-nav-item text-danger" @onclick="CerrarSesion">
        <i class="bi bi-box-arrow-right"></i>
        <span>Salir</span>
    </button>
</div>

@code {
    private PacienteCrearDTO _model = new();
    private List<ObraSocialDTO> _obrasSociales = new();

    private bool _cargando = true;
    private bool _permitido = false;
    private bool _guardando = false;
    private string? _error;

protected override async Task OnInitializedAsync()
{
    try
    {
        var me = await Auth.MeAsync();
        if (me is null || (me.Rol != "Administrador" && me.Rol != "Secretaria"))
        {
            _permitido = false;
            Nav.NavigateTo("/", true);
            return;
        }

        _permitido = true;
        _model = new PacienteCrearDTO { IsProvisional = true };
        _obrasSociales = await ObrasSrv.ListarAsync() ?? new();
    }
    catch
    {
        _permitido = false;
    }
    finally
    {
        _cargando = false;
    }
}

    private async Task GuardarAsync()
    {
        _error = null;
        _guardando = true;

        try
        {
            var creado = await PacienteSrv.CrearAsync(_model);
            if (creado is null)
            {
                _error = "No se pudo crear. Verifique los datos.";
                return;
            }
            Nav.NavigateTo("/Administrador/pacientes", true);
        }
        catch (Exception ex)
        {
            if (ex.Message.Contains("DNI_EXISTE", StringComparison.OrdinalIgnoreCase))
                _error = "Ya existe un paciente con ese DNI.";
            else
                _error = "Error: " + ex.Message;
        }
        finally
        {
            _guardando = false;
        }
    }

    private void VolverLista() => Nav.NavigateTo("/Administrador/pacientes");
    private void IrInicio() => Nav.NavigateTo("/Administrador/home");
    
    private async Task CerrarSesion()
    {
        await Auth.LogoutAsync();
        Nav.NavigateTo("/", true);
    }
}